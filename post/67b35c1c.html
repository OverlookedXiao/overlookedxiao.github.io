<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>NAT原理以及UDP穿透 | XiaoJun的个人笔记</title><meta name="author" content="XiaoJun"><meta name="copyright" content="XiaoJun"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="NAT 原理以及 UDP 穿透: 本文详细介绍了 NAT 的原理，并以此作为基础介绍了 UDP 穿透的原理和实现。 一、NAT基础和分类: NAT(Network Address Translation)全称为「网络地址转换」，用于为了解决"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.overlooked.top/post/67b35c1c.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://lib.baomitu.com/fancyapps-ui/4.0.31/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.json",preload:!1,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:{limitDay:730,position:"top",messagePrev:"本文最后更新于",messageNext:"天前，其中的信息可能已经不够准确，请您酌情参考！"},highlight:{plugin:"prismjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:500},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://lib.baomitu.com/flickr-justified-gallery/2.1.2/fjGallery.min.js",css:"https://lib.baomitu.com/flickr-justified-gallery/2.1.2/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"NAT原理以及UDP穿透",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-11-16 10:51:53"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/css/marge.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 文章分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url('https://image.overlooked.top/img/cover/2.png')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">XiaoJun的个人笔记</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 文章分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">NAT原理以及UDP穿透</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-11-12T16:39:27.000Z" title="发表于 2022-11-13 00:39:27">2022-11-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-16T02:51:53.000Z" title="更新于 2022-11-16 10:51:53">2022-11-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>14分钟</span></span><span class="post-meta-separator">|</span><span data-flag-title="NAT原理以及UDP穿透"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/post/67b35c1c.html#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="NAT-原理以及-UDP-穿透">NAT 原理以及 UDP 穿透</h2><p>本文详细介绍了 NAT 的原理，并以此作为基础介绍了 UDP 穿透的原理和实现。</p><h3 id="一、NAT基础和分类">一、NAT基础和分类</h3><p>NAT(Network Address Translation)全称为「网络地址转换」，用于为了解决 IPv4 地址短缺的问题。NAT 可以将私有 IP 地址转换为公有 IP 地址，以便多台内网主机只需要共用一个公有 IP 地址，便可以正常与互联网进行通信。</p><h4 id="NAT-可以分为两大类：">NAT 可以分为两大类：</h4><ol><li>基础NAT：网络地址转换(Network Address Translation)</li><li>NAPT：网络地址端口转换(Network Address Port Translation)<br><img src="https://image.overlooked.top/img/nat/nat_1.png" alt="nat_1.png"></li></ol><h4 id="1-基础NAT">1. 基础NAT</h4><p>基础 NAT 仅对网络地址进行转换，要求对每一个当前连接都要对应一个公网IP地址，所以需要有一个公网 ip 池；基础 NAT 内部有一张 NAT 表以记录对应关系，其映射关系如下：</p><table><thead><tr><th style="text-align:center">内网ip</th><th style="text-align:center">外网ip</th></tr></thead><tbody><tr><td style="text-align:center">192.168.1.1</td><td style="text-align:center">1.2.3.4</td></tr><tr><td style="text-align:center">192.168.1.12</td><td style="text-align:center">1.2.3.5</td></tr><tr><td style="text-align:center">192.168.1.123</td><td style="text-align:center">1.2.3.6</td></tr></tbody></table><blockquote><p>基础 NAT 又分为：静态 NAT 和 动态 NAT ，其区别在于：静态要求内网ip和外网ip存在固定的一 一对应关系，而动态不存在这种固定的对应关系。</p></blockquote><h4 id="2-NAPT">2. NAPT</h4><p>NAPT 需要对网络地址和端口都进行转换，这种类型允许多台主机共用一个公网 ip 地址，NAPT 内部同样有一张 NAT 表，并标注了端口，以记录对应关系，其映射关系如下：</p><table><thead><tr><th style="text-align:center">内网ip</th><th style="text-align:center">外网ip</th></tr></thead><tbody><tr><td style="text-align:center">192.168.1.10:1025</td><td style="text-align:center">1.2.3.4:1025</td></tr><tr><td style="text-align:center">192.168.1.11:3333</td><td style="text-align:center">1.2.3.5:3344</td></tr><tr><td style="text-align:center">192.168.1.12:7788</td><td style="text-align:center">1.2.3.6:2000</td></tr></tbody></table><blockquote><p>NAPT又分为：锥型 NAT 和 对称型 NAT ，其对于映射关系有不同的权限限制。<br>锥型 NAT 在网络拓扑图上像圆锥，而对称型 NAT 在网络拓扑图上呈现对称性。</p></blockquote><h3 id="二、NAPT分类">二、NAPT分类</h3><p>总的来说， NAPT 可分为四种类型：1.完全锥型，2.受限锥型，3.端口受限锥型，4.对称型。</p><blockquote><p>目前市场上常见的都是 NAPT 类型，我们常说的 NAT 一般也是特指 NAPT ，故下文均用 NAT 代表 NAPT</p></blockquote><h4 id="1-完全锥型">1. 完全锥型</h4><p>从同一个内网地址端口(<code>192.168.1.1:7777</code>)发起的请求都由 NAT 转换成公网地址端口(<code>1.2.3.4:10000</code>)。<br>而内网地址端口(<code>192.168.1.1:7777</code>)可以收到任意外部主机发到公网地址端口(<code>1.2.3.4:10000</code>)的数据报。<br><img src="https://image.overlooked.top/img/nat/nat_2.png" alt="nat_2.png"></p><h4 id="2-受限锥型">2. 受限锥型</h4><blockquote><p>受限锥型也称地址受限锥型，其在完全锥型的基础上，对 ip 地址进行了限制。</p></blockquote><p>从同一个内网地址端口(<code>192.168.1.1:7777</code>)发起的请求都由 NAT 转换成公网地址端口(<code>1.2.3.4:10000</code>)，其访问的服务器为(<code>8.8.8.8:123</code>)。<br>只有当(<code>192.168.1.1:7777</code>)主动向(<code>8.8.8.8:123</code>)发送一个报文后，(<code>192.168.1.1:7777</code>)才可以收到(<code>8.8.8.8:xxxx</code>)发往(<code>1.2.3.4:10000</code>)的报文，进而发送给(<code>192.168.1.1:7777</code>)，而其它地址如(<code>9.9.9.9:456</code>)发送的报文则会被 NAT 丢弃。<br><img src="https://image.overlooked.top/img/nat/nat_3.png" alt="nat_3.png"></p><h4 id="3-端口受限锥型">3. 端口受限锥型</h4><blockquote><p>端口受限锥型，是在受限锥型的基础上，对端口也做了进一步的限制。</p></blockquote><p>从同一个内网地址端口(<code>192.168.1.1:7777</code>)发起的请求都由 NAT 转换成公网地址端口(<code>1.2.3.4:10000</code>)，其访问的服务器为(<code>8.8.8.8:123</code>)。<br>只有当(<code>192.168.1.1:7777</code>)主动向(<code>8.8.8.8:123</code>)发送一个报文后，(<code>192.168.1.1:7777</code>)才可以收到(<code>8.8.8.8:123</code>)发往(<code>1.2.3.4:10000</code>)的报文，进而发送给(<code>192.168.1.1:7777</code>)，而其它地址端口如(<code>8.8.8.8:456</code>)和(<code>9.9.9.9:456</code>)发送的报文则会被 NAT 丢弃。<br><img src="https://image.overlooked.top/img/nat/nat_4.png" alt="nat_4.png"></p><h4 id="4-对称型">4. 对称型</h4><blockquote><p>在对称型 NAT 中，只有来自于同一个内网地址端口、且针对同一目标地址端口的请求才会被 NAT 转换至同一个公网地址端口，否则的话， NAT 将为之分配一个新的公网地址端口。</p></blockquote><p>例如：内网地址端口(<code>192.168.1.1:7777</code>)发起请求到(<code>8.8.8.8:123</code>)，由 NAT 转换成公网地址端口(<code>1.2.3.4:10000</code>)，随后内网地址端口(<code>192.168.1.1:7777</code>)又发起请求到(<code>9.9.9.9:456</code>)，则 NAT 将分配新的公网地址端口(<code>1.2.3.4:20000</code>)，而其它地址端口如(<code>8.8.8.8:456</code>)和(<code>9.9.9.9:123</code>)发送的报文则会被 NAT 丢弃。<br><img src="https://image.overlooked.top/img/nat/nat_5.png" alt="nat_5.png"></p><blockquote><p>对称型 NAT 其实也可以理解为升级版的端口受限锥型 NAT ，其在端口受限锥型的基础上，增加了公网地址端口一对一分配功能。<br>可以这么说，在锥型 NAT 中映射关系和目标地址端口无关，而在对称型 NAT 中则有关。锥型 NAT 正因为其于目标地址端口无关，所以网络拓扑是圆锥型的。</p></blockquote><p>如下图所示，在锥型 NAT 中对于同一个内网地址端口来说其公网地址端口(<code>1.2.3.4:10000</code>)是固定的。<br><img src="https://image.overlooked.top/img/nat/nat_6.png" alt="nat_6.png"></p><h3 id="三、NAT的工作流程">三、NAT的工作流程</h3><p>按照上文的描述，我们可以很好的理解 NAT 对传输层协议(TCP/UDP)的处理，这里举例来更加深入的理解 NAT 的原理。</p><h4 id="1-发送数据">1. 发送数据</h4><p>当一个 TCP/UDP 的请求 <code>( 192.168.1.1:7777 =&gt; 8.8.8.8:123 )</code>到达 NAT 网关( <code>1.2.3.4</code> )时，由 NAT 修改报文的源地址和源端口以及相应的校验码，随后再发往目标：</p><pre class="line-numbers language-TEXT" data-language="TEXT"><code class="language-TEXT">192.168.1.1:7777 &#x3D;&gt; 1.2.3.4:10000 &#x3D;&gt; 8.8.8.8:123<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="2-接收数据">2. 接收数据</h4><p>随后( <code>8.8.8.8:123</code> )返回响应数据到( <code>1.2.3.4:10000</code> )， NAT 查询映射表，修改目的地址和目的端口以及相应的校验码，再将数据返回给真实的请求方：</p><pre class="line-numbers language-TEXT" data-language="TEXT"><code class="language-TEXT">8.8.8.8:123 &#x3D;&gt; 1.2.3.4:10000 &#x3D;&gt; 192.168.1.1:7777<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="3-其他协议">3. 其他协议</h4><p>对于常见的网络协议来说，除了 TCP/UDP 协议外还有 ICMP 等特殊协议，以及自定义实现的私有协议。例如 ICMP 协议工作在 IP 层，没有端口信息，NAT 以 ICMP 报文中的 <code>identifier</code> 作为标记，以此来判断这个报文是内网哪台主机发出的。下图为 <code>Cisco Packet Tracer</code> 下，在客户端发起 <code>TCP/UDP/ICMP</code> 请求后的 <code>NAT translations</code>：<br><img src="https://image.overlooked.top/img/nat/nat_7.png" alt="nat_7.png"></p><blockquote><p>当然还有一些特殊的协议，比如 FTP 协议，当请求一个文件传输时，主机在发送请求的同时也通知对方自己想要在哪个端口接受数据，NAT 必须进行特殊处理才能支持这种通信机制。<br>在 NAT 中有一个应用网关层(Application Layer Gateway, ALG)，以此来统一处理这些协议问题。</p></blockquote><h4 id="4-映射老化时间">4. 映射老化时间</h4><p>建立了 NAT 映射关系后，这些映射什么时候失效呢？</p><p>不同协议有不同的失效机制，比如 TCP 的通信在收到 RST 过后就会删除映射关系，或 TCP 在某个超时时间后也会自动失效。而 ICMP 在收到 ICMP 响应后就会删除映射关系，当然超时后也会自动失效。具体的实现还和各个厂商有关系。</p><h3 id="四、NAT类型探测">四、NAT类型探测</h3><p>探测 NAT 的类型是 NAT 穿透中的第一步，我们可以通过客户端和两个服务器端的交互来探测 NAT 的工作类型，以下是来源于 STUN 协议(<a target="_blank" rel="noopener external nofollow noreferrer" href="https://tools.ietf.org/html/rfc3489">https://tools.ietf.org/html/rfc3489</a>) 的探测流程图，在其上添加了一些标注：<br><img src="https://image.overlooked.top/img/nat/nat_8.png" alt="nat_8.png"></p><p>如图所示，我们可以整理出：</p><ol><li>客户端使用同一个内网地址端口分别向主服务器和协助服务器(不同IP)发起 UDP 请求，主服务器获取到客户端出口地址端口后，返回给客户端，客户端对比自己本地地址和出口地址是否一致，如果是则表示处于 <code>Open Internet</code> 中。</li><li>协助服务器同样也获取到了客户端出口地址端口，将该信息转发给主服务器，同样将该信息返回给客户端，客户端对比两个出口地址端口(1、主服务器返回的，2、协助服务器返回的)是否一致，如果是则表示处于 <code>Symmetric NAT</code> 中。</li><li>客户端再使用<code>不同的内网地址端口</code>分别向主服务器和协助服务器(不同IP)发起 UDP 请求，主服务器和协助服务器都可以获得一个新的客户端出口地址端口，协助服务器将客户端出口地址端口转发给主服务器。</li><li>主服务器向协助服务器获取到的客户端出口地址端口发送 UDP 数据，客户端如果可以收到数据，则表示处于 <code>Full-Cone NAT</code> 中。</li><li>主服务器使用另一个端口，向主服务器获取到的客户端出口地址端口发送 UDP 数据，如果客户端收到数据，则表示处于 <code>Restricted NAT</code> 中，否则处于 <code>Restricted-Port NAT</code> 中。</li></ol><blockquote><p>实际网络往往都更加复杂，比如：防火墙、多层 NAT 等原因，会导致无法准确的探测 NAT 类型。</p></blockquote><p>当然，实际上我们并不需要手动实现上述过程，我们有现成的NAT测试工具可用：<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/HMBSbige/NatTypeTester" title="NatTypeTester">GitHub：NatTypeTester</a><br>下载地址：<a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/HMBSbige/NatTypeTester/releases/download/3.4/NatTypeTester.exe">https://github.com/HMBSbige/NatTypeTester/releases/download/3.4/NatTypeTester.exe</a><br>打开软件，点击左侧菜单栏RFC 3489：<br><img src="https://image.overlooked.top/img/nat/nat_9.png" alt="nat_9.png"></p><p>上方菜单栏中可选择STUN服务器，大陆境内推荐使用QQ和MIWIFI：<br><img src="https://image.overlooked.top/img/nat/nat_10.png" alt="nat_10.png"></p><p>点击TEST即可得到测试结果，如上图的FullCone即为NAT1 (完全锥型)</p><h3 id="五、UDP穿透">五、UDP穿透</h3><p>在 NAT 的网络环境下，P2P 网络通信需要穿透 NAT 才能够实现。在熟悉 NAT 原理过后，我们就可以很好的理解如何来进行 NAT 穿透了。NAT 穿透的思想在于：如何复用 NAT 中的映射关系？</p><p>在<code>锥型NAT</code>中，同一个内网地址端口访问不同的目标只会建立<code>一条映射关系</code>，所以可以复用，而<code>对称型NAT</code>不行。同时，由于 TCP 工作比较复杂，在 NAT 穿透中存在一些局限性，所以在实际场景中 UDP 穿透使用得更广泛一些，这里我们详细看看 UDP 穿透的原理和流程。</p><blockquote><p>我们以 <code>Restricted-Port NAT</code> 类型作为例子，因为其使用得最为广泛，同时权限也是最为严格的，在理解 <code>Restricted-Port NAT</code> 类型穿透后，<code>Full-Cone NAT</code> 和 <code>Restricted NAT</code> 就触类旁通了；<br>在实际网络场景下往往都是非常复杂的，比如：防火墙、多层NAT、单侧NAT，这里我们选择了两端都处于一层 NAT 的场景来进行演示讲解，可以让我们更容易的进行理解。</p></blockquote><p>在我们的演示环境下，有 <code>PC1，Router1，PC2，Router2，Server</code> 五台设备；公网服务器用于获取客户端实际的出口地址端口，UDP 穿透的流程如下：</p><ol><li><code>PC1(192.168.1.1:7777)</code> 发送 UDP 请求到 <code>Server(9.9.9.9:1024)</code>，此时 Server 可以获取到 PC1 的出口地址端口(也就是 Router1 的出口地址端口) <code>1.2.3.4:10000</code>，同时 Router1 添加一条映射 <code>192.168.1.1:7777 &lt;=&gt; 1.2.3.4:10000 &lt;=&gt; 9.9.9.9:1024</code></li><li><code>PC2(192.168.2.1:8888)</code> 同样发送 UDP 请求到 Server，Router2 添加一条映射 <code>192.168.2.1:8888 &lt;=&gt; 5.6.7.8:20000 &lt;=&gt; 9.9.9.9:1024</code></li><li>Server 将 PC2 的出口地址端口(<code>5.6.7.8:20000</code>) 发送给 PC1</li><li>Server 将 PC1 的出口地址端口(<code>1.2.3.4:10000</code>) 发送给 PC2</li><li>PC1 使用相同的内网地址端口(<code>192.168.1.1:7777</code>)发送 UDP 请求到 PC2 的出口地址端口(<code>Router2 5.6.7.8:20000</code>)，此时 Router1 添加一条映射 <code>192.168.1.1:7777 &lt;=&gt; 1.2.3.4:10000 &lt;=&gt; 5.6.7.8:20000</code>，与此同时 Router2 没有关于 <code>1.2.3.4:10000</code> 的映射，这个请求将被 Router2 丢弃</li><li>PC2 使用相同的内网地址端口(<code>192.168.2.1:8888</code>)发送 UDP 请求到 PC1 的出口地址端口(<code>Router1 1.2.3.4:10000</code>)，此时 Router2 添加一条映射 <code>192.168.2.1:8888 &lt;=&gt; 5.6.7.8:20000 &lt;=&gt; 1.2.3.4:10000</code>，与此同时 Router1 有一条关于 <code>5.6.7.8:20000</code> 的映射(上一步中添加的)，Router1 将报文转发给 PC1(<code>192.168.1.1:7777</code>)</li><li>在 Router1 和 Router2 都有了对方的映射关系，此时 PC1 和 PC2 通过 UDP 穿透建立通信。</li></ol><p><img src="https://image.overlooked.top/img/nat/nat_11.png" alt="nat_11.png"></p><h3 id="六、拓展研究">六、拓展研究</h3><p>在实践了以上步骤后，我们对 锥型NAT 下的 UDP 穿透已经有了大致的了解，那我们接着再拓展研究一下「其他场景」。</p><h4 id="1-Symmetric-NAT可以穿透吗？">1. Symmetric NAT可以穿透吗？</h4><p>根据 <code>Symmetric NAT</code> 的特性我们可以知道当请求的目标端口地址改变后，会创建新的一对映射关系，我们无法知晓新的映射关系中的端口号；但是在实际场景下，部分路由器对于 <code>Symmetric NAT</code> 的生成算法过于简单，新的端口可能呈现于：递增、递减、跳跃等特征，所以这种条件下，我们可以基于端口猜测，来穿透 <code>Symmetric NAT</code>。</p><blockquote><p>如果两端的 <code>Symmetric NAT</code> 路由器是已知的，我们可以直接逆向分析映射生成算法，即可准确预测端口号。</p></blockquote><h4 id="2-TCP穿透有哪些难点？">2. TCP穿透有哪些难点？</h4><p>TCP 穿透的流程基本和 UDP 穿透一样。</p><p>在标准 socket 规范中，UDP 可以允许多个 socket 绑定到同一个本地端口，但 TCP 不行，在 TCP 中我们不能在同一个端口上既 <code>listen</code> 又进行 <code>connect</code>；不过在部分操作系统下 socket 提供了端口复用选项(<code>SO_REUSEADDR / SO_REUSEPORT</code>) 可以允许 TCP 绑定多个 socket。</p><p>在使用端口复用选项后，TCP 就按照 UDP 穿透的流程一样借助公网服务器然后向对端发送 <code>syn</code> 报文了，其中靠后的 <code>syn</code> 报文就可以正确穿透完成 TCP 握手并建立连接。</p><p>但是在<code>实际场景</code>下还有诸多的阻碍，不同厂商的 NAT 实现机制有一些差异，比如某些针对 TCP 的实现有：</p><ol><li>对端 NAT 在接收到 <code>syn</code> 由于没有找到映射而返回 <code>RST</code> 报文，而本端 NAT 在接收到 <code>RST</code> 报文后删除了此条映射</li><li>由于主机生成的 <code>syn</code> 报文中的 <code>seq</code> 序号为随机值，如果 NAT 开启了 <code>syn</code> 过滤，对于没有标记过的 <code>seq</code> 的报文将直接丢弃</li><li>其它不可控因素等等</li></ol><h4 id="3-无第三方服务器的穿透">3. 无第三方服务器的穿透</h4><p>目前可行的一种不需要第三方服务器实现 NAT 穿透的项目：<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/samyk/pwnat">https://github.com/samyk/pwnat</a></p><p>文中作者先提出了一种便于理解的网络拓扑，客户端位于公网，服务器位于 NAT 下，我们必须预先知道服务器的公网地址；在这个方法下，服务器不断的向外部未分配的地址发送 <code>ICMP(ECHO REQUEST)</code> 消息，服务器端的 NAT 将保留一条 ICMP 响应的映射，由于目的地址未分配所以没有设备会响应服务器发出的请求，此时由客户端发送一条伪装的 <code>ICMP(DESTINATION UNREACHABLE)</code> 给服务器，服务器可以收到该条消息并从中获取到客户端的地址；随后便可以根据预先约定的端口进行穿透并通信了。</p><p>但是如果客户端也位于 NAT 下呢，由于 NAT 可能会更改源端口信息(不同厂商的NAT实现不同)，导致无法向上文一样使用预设端口进行通信，所以这里需要和 <code>Symmetric NAT</code> 穿透一样进行端口猜测。</p><h3 id="七、总结">七、总结</h3><p>本文从 NAT 原理出发，详细介绍了不同 NAT 类型的工作流程和原理，在此基础上我们深入学习和实现了 锥型NAT 的穿透，并拓展介绍了一些特殊的穿透场景。</p><p>NAT 的出现极大的缓解了 IPv4 地址短缺，同时也延迟了 IPv6 的推广，但 IPv6 是大势所趋，未来使用 NAT 的场景可能会慢慢减少；但无论怎样， NAT 的原理和策略都非常值得我们学习，比如：</p><ol><li>NAT 是一个天然的防火墙，</li><li>NAT 其实可以看作是代理服务器，</li><li>NAT 可以作为负载均衡服务器，</li><li>等等。</li></ol></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://www.overlooked.top">XiaoJun</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.overlooked.top/post/67b35c1c.html">https://www.overlooked.top/post/67b35c1c.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.overlooked.top" target="_blank">XiaoJun的个人笔记</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/NAT/">NAT</a><a class="post-meta__tags" href="/tags/TCP/">TCP</a><a class="post-meta__tags" href="/tags/UDP/">UDP</a><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><a class="post-meta__tags" href="/tags/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a></div><div class="post_share"><div class="social-share" data-image="https://image.overlooked.top/img/cover/2.png" data-sites="qq,wechat,weibo"></div><link rel="stylesheet" href="https://lib.baomitu.com/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://lib.baomitu.com/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/reward-wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/reward-wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/reward-alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/reward-alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/post/5d36ff15.html"><img class="prev-cover" src="https://image.overlooked.top/img/cover/1.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Markdown基本语法</div></div></a></div><div class="next-post pull-right"><a href="/post/963f24df.html"><img class="next-cover" src="https://image.overlooked.top/img/cover/3.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android基础之apk的组成</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/post/5532fc86.html" title="计算机网络知识点"><img class="cover" src="https://image.overlooked.top/img/cover/13.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-26</div><div class="title">计算机网络知识点</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">XiaoJun</div><div class="author-info__description">生活本不易，且行且珍惜</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">18</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="http://wpa.qq.com/msgrd?v=3&amp;uin=1520559187&amp;site=qq&amp;menu=yes" rel="external nofollow noreferrer" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/img/wechat.jpg" target="_blank" title="WeChat"><i class="fab fa-weixin"></i></a><a class="social-icon" href="https://github.com/OverlookedXiao" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:1520559187@qq.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到XiaoJun的个人笔记 , 如果喜欢记得收藏奥～～～</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#NAT-%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A-UDP-%E7%A9%BF%E9%80%8F"><span class="toc-number">1.</span> <span class="toc-text">NAT 原理以及 UDP 穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81NAT%E5%9F%BA%E7%A1%80%E5%92%8C%E5%88%86%E7%B1%BB"><span class="toc-number">1.1.</span> <span class="toc-text">一、NAT基础和分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NAT-%E5%8F%AF%E4%BB%A5%E5%88%86%E4%B8%BA%E4%B8%A4%E5%A4%A7%E7%B1%BB%EF%BC%9A"><span class="toc-number">1.1.1.</span> <span class="toc-text">NAT 可以分为两大类：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9F%BA%E7%A1%80NAT"><span class="toc-number">1.1.2.</span> <span class="toc-text">1. 基础NAT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-NAPT"><span class="toc-number">1.1.3.</span> <span class="toc-text">2. NAPT</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81NAPT%E5%88%86%E7%B1%BB"><span class="toc-number">1.2.</span> <span class="toc-text">二、NAPT分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AE%8C%E5%85%A8%E9%94%A5%E5%9E%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">1. 完全锥型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%97%E9%99%90%E9%94%A5%E5%9E%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">2. 受限锥型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E7%AB%AF%E5%8F%A3%E5%8F%97%E9%99%90%E9%94%A5%E5%9E%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">3. 端口受限锥型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%AF%B9%E7%A7%B0%E5%9E%8B"><span class="toc-number">1.2.4.</span> <span class="toc-text">4. 对称型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81NAT%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.3.</span> <span class="toc-text">三、NAT的工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.1.</span> <span class="toc-text">1. 发送数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">1.3.2.</span> <span class="toc-text">2. 接收数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%85%B6%E4%BB%96%E5%8D%8F%E8%AE%AE"><span class="toc-number">1.3.3.</span> <span class="toc-text">3. 其他协议</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%98%A0%E5%B0%84%E8%80%81%E5%8C%96%E6%97%B6%E9%97%B4"><span class="toc-number">1.3.4.</span> <span class="toc-text">4. 映射老化时间</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81NAT%E7%B1%BB%E5%9E%8B%E6%8E%A2%E6%B5%8B"><span class="toc-number">1.4.</span> <span class="toc-text">四、NAT类型探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81UDP%E7%A9%BF%E9%80%8F"><span class="toc-number">1.5.</span> <span class="toc-text">五、UDP穿透</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%8B%93%E5%B1%95%E7%A0%94%E7%A9%B6"><span class="toc-number">1.6.</span> <span class="toc-text">六、拓展研究</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Symmetric-NAT%E5%8F%AF%E4%BB%A5%E7%A9%BF%E9%80%8F%E5%90%97%EF%BC%9F"><span class="toc-number">1.6.1.</span> <span class="toc-text">1. Symmetric NAT可以穿透吗？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-TCP%E7%A9%BF%E9%80%8F%E6%9C%89%E5%93%AA%E4%BA%9B%E9%9A%BE%E7%82%B9%EF%BC%9F"><span class="toc-number">1.6.2.</span> <span class="toc-text">2. TCP穿透有哪些难点？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%97%A0%E7%AC%AC%E4%B8%89%E6%96%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%A9%BF%E9%80%8F"><span class="toc-number">1.6.3.</span> <span class="toc-text">3. 无第三方服务器的穿透</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">1.7.</span> <span class="toc-text">七、总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/post/3df782a1.html" title="DRSSTC教程 第五章 - DRSSTC的功率电路设计"><img src="https://image.overlooked.top/img/cover/18.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="DRSSTC教程 第五章 - DRSSTC的功率电路设计"></a><div class="content"><a class="title" href="/post/3df782a1.html" title="DRSSTC教程 第五章 - DRSSTC的功率电路设计">DRSSTC教程 第五章 - DRSSTC的功率电路设计</a><time datetime="2023-06-05T11:23:27.000Z" title="发表于 2023-06-05 19:23:27">2023-06-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/11ad15b.html" title="DRSSTC教程 第四章 - DRSSTC的驱动电路原理"><img src="https://image.overlooked.top/img/cover/17.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="DRSSTC教程 第四章 - DRSSTC的驱动电路原理"></a><div class="content"><a class="title" href="/post/11ad15b.html" title="DRSSTC教程 第四章 - DRSSTC的驱动电路原理">DRSSTC教程 第四章 - DRSSTC的驱动电路原理</a><time datetime="2023-06-05T08:24:35.000Z" title="发表于 2023-06-05 16:24:35">2023-06-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/3a404290.html" title="DRSSTC教程 第三章 - 特斯拉线圈的灭弧电路设计"><img src="https://image.overlooked.top/img/cover/16.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="DRSSTC教程 第三章 - 特斯拉线圈的灭弧电路设计"></a><div class="content"><a class="title" href="/post/3a404290.html" title="DRSSTC教程 第三章 - 特斯拉线圈的灭弧电路设计">DRSSTC教程 第三章 - 特斯拉线圈的灭弧电路设计</a><time datetime="2023-06-05T04:17:10.000Z" title="发表于 2023-06-05 12:17:10">2023-06-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/bb8c4a88.html" title="DRSSTC教程 第二章 - 特斯拉线圈的原理分析"><img src="https://image.overlooked.top/img/cover/15.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="DRSSTC教程 第二章 - 特斯拉线圈的原理分析"></a><div class="content"><a class="title" href="/post/bb8c4a88.html" title="DRSSTC教程 第二章 - 特斯拉线圈的原理分析">DRSSTC教程 第二章 - 特斯拉线圈的原理分析</a><time datetime="2023-01-09T03:18:34.000Z" title="发表于 2023-01-09 11:18:34">2023-01-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/post/f40ed205.html" title="DRSSTC教程 第一章 - 特斯拉线圈的分类和欣赏"><img src="https://image.overlooked.top/img/cover/14.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="DRSSTC教程 第一章 - 特斯拉线圈的分类和欣赏"></a><div class="content"><a class="title" href="/post/f40ed205.html" title="DRSSTC教程 第一章 - 特斯拉线圈的分类和欣赏">DRSSTC教程 第一章 - 特斯拉线圈的分类和欣赏</a><time datetime="2023-01-07T10:42:12.000Z" title="发表于 2023-01-07 18:42:12">2023-01-07</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By XiaoJun</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi , welcome to my <a href="https://www.overlooked.top">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button></div><div id="rightside-config-show"><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://lib.baomitu.com/fancyapps-ui/4.0.31/fancybox.umd.min.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/instant.page/5.1.0/instantpage.min.js" type="module"></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://lib.baomitu.com/pangu/4.0.7/pangu.min.js").then((()=>{pangu.autoSpacingPage()}))}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo.overlooked.top/",region:"",onCommentLoaded:function(){btf.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const o=document.getElementById("twikoo-count");o&&twikoo.getCommentsCount({envId:"https://twikoo.overlooked.top/",region:"",urls:[window.location.pathname],includeReply:!1}).then((function(t){o.innerText=t[0].count})).catch((function(o){console.error(o)}))})()},t=()=>{"object"!=typeof twikoo?getScript("https://lib.baomitu.com/twikoo/1.6.7/twikoo.all.min.js").then(o):setTimeout(o,0)};t()})()</script></div><script src="/js/marge.js"></script><script src="/hijiki/live2d.js" defer async></script><canvas class="fireworks" mobile="true"></canvas><script src="https://lib.baomitu.com/butterfly-extsrc/1.1.3/fireworks.min.js"></script><script defer id="fluttering_ribbon" mobile="true" src="https://lib.baomitu.com/butterfly-extsrc/1.1.3/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//npm.elemecdn.com/penndu@1.0.0/bsz.js"></script></div></body></html>